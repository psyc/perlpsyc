#!/usr/bin/perl -I/usr/depot/lib/perl5
#
# usage: $0 [-t <uniform>] [-b <uniform>] [-m <method>] [<files>]
#
# this collects everything it gets from files or stdin
# and tries to send it to the target in a single packet
# this will obviously encounter size limits when using UDP

require 5.000;
use Net::PSYC;

my $noargs = $#ARGV == -1;

use Getopt::Std;
getopt('tbm');

$binder = $opt_b || 'psyc://127.0.0.1:0d/';	# get yourself any udp port
$target = $opt_t || 'psyc://127.0.0.1:2244/';	# talk to local "listen" script
$method = $opt_m || '_bulk';		# couldnt think of anything better

bind_uniform( $binder );

print STDERR <<X if $noargs and -t STDIN;
*** $0 process bound to -b $binder address.
*** Message will be delivered by -m $method to -t $target.
*** Insert a multiline message now.
*** Message will be sent when input is terminated by CTRL-D.
*** Available options are -b, -t, -m and -q to quieten this information.

X

my $d = '';
# i know there are better ways to do this..
$d .= $_ while <>;

go($d);
exit;


sub go {
	my $a = shift;
	$rc = sendmsg ($target, $method, $a); # , { _kilroy => 'woz ere' } );
	die "send: $rc" if $rc;
}

